<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ ë¡œë“œë·°</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: black;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #panorama {
            width: 100%;
            height: 100%;
            background-color: black;
        }
        
        .error-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 1000;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 999;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="panorama"></div>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>ë¡œë“œë·° ë¡œë”© ì¤‘...</div>
    </div>
    <div id="error" class="error-message" style="display: none;">
        <h3>ë¡œë“œë·°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
        <p>í•´ë‹¹ ìœ„ì¹˜ì— ë¡œë“œë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        <button onclick="retryPanorama()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
            ë‹¤ì‹œ ì‹œë„
        </button>
    </div>

    <!-- ë„¤ì´ë²„ Maps API v3 + íŒŒë…¸ë¼ë§ˆ ì„œë¸Œëª¨ë“ˆ -->
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=x6vhzkmhb4&submodules=panorama&callback=initNaverMaps"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let panorama = null;
        let isInitialized = false;
        let currentPosition = null;
        
        // URLì—ì„œ ì¢Œí‘œ íŒŒë¼ë¯¸í„° ë°›ê¸° (ì˜ˆ: ?lat=37.5665&lng=126.9780)
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat')) || 37.5665; // ê¸°ë³¸ê°’: ì„œìš¸ì‹œì²­
            const lng = parseFloat(urlParams.get('lng')) || 126.9780;
            return { lat, lng };
        }
        
        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function showError(message = 'í•´ë‹¹ ìœ„ì¹˜ì— ë¡œë“œë·°ê°€ ì—†ìŠµë‹ˆë‹¤.') {
            hideLoading();
            document.getElementById('error').style.display = 'flex';
            document.querySelector('#error p').textContent = message;
        }
        
        // ë„¤ì´ë²„ Maps API ë¡œë“œ ì™„ë£Œ ì½œë°±
        function initNaverMaps() {
            console.log('âœ… ë„¤ì´ë²„ Maps API ë¡œë“œ ì™„ë£Œ');
            console.log('ğŸ” naver ê°ì²´ ì¡´ì¬:', typeof naver !== 'undefined');
            console.log('ğŸ” naver.maps.Panorama ì¡´ì¬:', typeof naver.maps.Panorama !== 'undefined');
            
            if (typeof naver !== 'undefined' && naver.maps && naver.maps.Panorama) {
                initPanorama();
            } else {
                showError('ë„¤ì´ë²„ Maps API ë¡œë“œ ì‹¤íŒ¨');
            }
        }
        
        // íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™”
        function initPanorama() {
            if (isInitialized) return;
            isInitialized = true;
            
            const { lat, lng } = getUrlParams();
            currentPosition = { lat, lng };
            
            console.log('ğŸŒ íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™” ì‹œì‘:', lat, lng);
            
            try {
                // íŒŒë…¸ë¼ë§ˆ ìƒì„±
                panorama = new naver.maps.Panorama('panorama', {
                    position: new naver.maps.LatLng(lat, lng),
                    pov: {
                        pan: 0,    // ìˆ˜í‰ ê°ë„
                        tilt: 0,   // ìˆ˜ì§ ê°ë„
                        fov: 90    // ì‹œì•¼ê°
                    },
                    visible: true
                });
                
                // íŒŒë…¸ë¼ë§ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                naver.maps.Event.addListener(panorama, 'pano_changed', function() {
                    console.log('âœ… íŒŒë…¸ë¼ë§ˆ ë¡œë“œ ì„±ê³µ');
                    hideLoading();
                });
                
                naver.maps.Event.addListener(panorama, 'init', function() {
                    console.log('âœ… íŒŒë…¸ë¼ë§ˆ ì´ˆê¸°í™” ì™„ë£Œ');
                    hideLoading();
                });
                
                naver.maps.Event.addListener(panorama, 'error', function(error) {
                    console.error('âŒ íŒŒë…¸ë¼ë§ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showError('íŒŒë…¸ë¼ë§ˆ ë¡œë“œ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                });
                
                naver.maps.Event.addListener(panorama, 'no_spot_found', function() {
                    console.warn('âš ï¸ í•´ë‹¹ ìœ„ì¹˜ì— ë¡œë“œë·° ìŠ¤íŒŸì´ ì—†ìŠµë‹ˆë‹¤');
                    showError('í•´ë‹¹ ìœ„ì¹˜ì— ë¡œë“œë·°ê°€ ì—†ìŠµë‹ˆë‹¤');
                });
                
                console.log('âœ… íŒŒë…¸ë¼ë§ˆ ê°ì²´ ìƒì„± ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ íŒŒë…¸ë¼ë§ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                showError('íŒŒë…¸ë¼ë§ˆ ìƒì„± ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ë‹¤ì‹œ ì‹œë„ í•¨ìˆ˜
        function retryPanorama() {
            if (currentPosition) {
                isInitialized = false;
                showLoading();
                initPanorama();
            }
        }
        
        // ë„¤ì´í‹°ë¸Œ ì•±ì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜ë“¤
        window.setPanoramaPosition = function(lat, lng) {
            console.log('ğŸ“ íŒŒë…¸ë¼ë§ˆ ìœ„ì¹˜ ë³€ê²½:', lat, lng);
            if (panorama) {
                panorama.setPosition(new naver.maps.LatLng(lat, lng));
            }
        };
        
        window.setPanoramaPOV = function(pan, tilt, fov) {
            console.log('ğŸ‘ï¸ íŒŒë…¸ë¼ë§ˆ ì‹œì  ë³€ê²½:', pan, tilt, fov);
            if (panorama) {
                panorama.setPov({ pan, tilt, fov });
            }
        };
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ');
            showLoading();
        });
        
        // í™”ë©´ íšŒì „ ì²˜ë¦¬
        window.addEventListener('orientationchange', function() {
            console.log('ğŸ“± í™”ë©´ íšŒì „ ê°ì§€');
            setTimeout(function() {
                if (panorama) {
                    panorama.refresh();
                }
            }, 100);
        });
        
        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì²˜ë¦¬
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('ğŸ“± í˜ì´ì§€ ìˆ¨ê¹€ - íŒŒë…¸ë¼ë§ˆ ì¼ì‹œì •ì§€');
                if (panorama) {
                    panorama.setVisible(false);
                }
            } else {
                console.log('ğŸ“± í˜ì´ì§€ í‘œì‹œ - íŒŒë…¸ë¼ë§ˆ ì¬ê°œ');
                if (panorama) {
                    panorama.setVisible(true);
                }
            }
        });
    </script>
</body>
</html>
